name: Sync Upstream

# 触发条件：每天北京时间5点20分自动运行，也可手动触发
on:
  schedule:
    - cron: '20 21 * * *'  # 每天 UTC 时间21点20分（北京时间次日5点20分）运行
  workflow_dispatch:  # 允许手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：拉取你的仓库代码
      - name: Checkout your repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 拉取所有历史提交，确保能正常合并

      # 步骤2：添加上游仓库地址（原仓库）
      - name: Add upstream repo
        run: |
          git remote add upstream https://github.com/6dylan6/jdpro.git
          git fetch upstream  # 获取上游仓库的最新代码

      # 新增：配置 Git 提交者身份（关键步骤，解决身份未知错误）
      - name: Configure Git identity
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      # 步骤3：合并上游仓库的更新到你的仓库
      - name: Merge upstream updates
        run: |
          git checkout main  # 切换到你的主分支（如果是 master 则修改为 master）
          git merge upstream/main  # 合并上游的 main 分支（如果上游是 master 则修改为 upstream/master）
          git push origin main  # 推送到你的仓库

      # 步骤4：处理可能的冲突（可选，冲突时会失败，需手动解决）
      - name: Handle merge conflicts (if any)
        if: failure()
        run: |
          echo "合并冲突！请手动同步上游仓库：https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork"
