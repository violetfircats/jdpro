name: Sync Upstream

# 触发条件：每天北京时间 5:20（UTC 21:20）自动运行，也可手动触发
on:
  schedule:
    - cron: '20 21 * * *'   # UTC 21:20 → 北京时间次日 5:20
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 2          # GitHub Actions 层兜底 2 min（最小粒度）

    steps:
      # 1. 拉取自己仓库完整历史
      - name: Checkout your repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. 添加上游仓库并抓取最新代码
      - name: Add upstream repo
        run: |
          git remote add upstream https://github.com/6dylan6/jdpro.git
          git fetch upstream

      # 3. 配置 Git 提交者身份（防止合并时提示 unknown identity）
      - name: Configure Git identity
        run: |
          git config --global user.name  "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      # 4. 合并上游更新并推送 —— 90 秒内必须完成，否则强制终止
      - name: Merge upstream updates (90s timeout)
        run: |
          timeout 90s bash -c '
            set -e
            git checkout main
            git merge upstream/main
            git push origin main
          '

      # 5. 如果上面失败，给出提示
      - name: Handle merge conflicts or timeout
        if: failure()
        run: |
          echo "::error::同步失败！可能原因：合并冲突 或 90 秒超时。"
          echo "手动同步教程：https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork"
